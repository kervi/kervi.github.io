

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Controllers &mdash; Kervi 0.15.0 - beta documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Dashboards" href="dashboards.html" />
    <link rel="prev" title="Actions" href="actions.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Kervi
          

          
          </a>

          
            
            
              <div class="version">
                0.15.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Get started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hello_world.html">Hello world</a></li>
<li class="toctree-l2"><a class="reference internal" href="sensors.html">Sensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions.html">Actions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dashboards.html">Dashboards</a></li>
<li class="toctree-l2"><a class="reference internal" href="camera.html">Camera (Raspberry Pi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="bigpicture.html">The big picture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dashboards.html">Dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensors.html">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../signals.html">Signal handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../actions.html">Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../camera.html">Camera and video</a></li>
<li class="toctree-l1"><a class="reference internal" href="../motors.html">Motors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../display.html">Displays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hal.html">Hardware and devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devices/index.html">Device library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi_process.html">Process distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed.html">Distributed applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messaging.html">Messaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../service.html">Run as service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Commandline tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ipc.html">Interprocess communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kervi_api.html">Kervi API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contribute</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kervi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Get started</a> &raquo;</li>
        
      <li>Controllers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="controllers">
<h1>Controllers<a class="headerlink" href="#controllers" title="Permalink to this headline">Â¶</a></h1>
<p>Kervi controllers reacts to one or more inputs and computes the value of one or more outputs.
The input could come from the user via the web based UI, sensors or other application logic.</p>
<p>Below is a fan controller that takes an temperature input and calculates the speed of the fan (in percent).
The controller starts the fan when the input temperature is over 20 degrees and dynamically increases the speed and reach
max speed when the temperature is 80 degrees.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

      <span class="kn">from</span> <span class="nn">kervi.application</span> <span class="kn">import</span> <span class="n">Application</span>

      <span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>

      <span class="c1">#create sensors</span>
      <span class="kn">from</span> <span class="nn">kervi.sensors</span> <span class="kn">import</span> <span class="n">Sensor</span>
      <span class="kn">from</span> <span class="nn">kervi.devices.sensors.system</span> <span class="kn">import</span> <span class="n">CPUTempSensorDeviceDriver</span>

      <span class="c1">#create a senors that uses CPU temp device driver</span>
      <span class="n">cpu_temp_sensor</span> <span class="o">=</span> <span class="n">Sensor</span><span class="p">(</span><span class="s2">&quot;CPUTempSensor&quot;</span><span class="p">,</span><span class="s2">&quot;CPU temp&quot;</span><span class="p">,</span> <span class="n">CPUTempSensorDeviceDriver</span><span class="p">())</span>

      <span class="c1">#link to dashboard</span>
      <span class="n">cpu_temp_sensor</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">show_sparkline</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">link_to_header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="n">cpu_temp_sensor</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;chart&quot;</span><span class="p">)</span>

      <span class="c1">#define a controller</span>
      <span class="kn">from</span> <span class="nn">kervi.controllers</span> <span class="kn">import</span> <span class="n">Controller</span>
      <span class="kn">from</span> <span class="nn">kervi.values</span> <span class="kn">import</span> <span class="n">NumberValue</span>

      <span class="k">class</span> <span class="nc">FanController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
          <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">Controller</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;fan_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;Fan&quot;</span><span class="p">)</span>

              <span class="c1">#define an input that is a number</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">150</span>

              <span class="c1">#define an output that is a number</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">fan_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;fan_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Fan speed&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>

          <span class="c1">#input_changed is called by the framework when any of the controller inputs changes its value.</span>
          <span class="k">def</span> <span class="nf">input_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changed_input</span><span class="p">):</span>
              <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">value</span>
              <span class="k">if</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">fan_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">/</span> <span class="mi">80</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                  <span class="k">if</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                      <span class="n">speed</span> <span class="o">=</span> <span class="mi">100</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">fan_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">speed</span>

      <span class="c1">#Instantiate the controller</span>
      <span class="n">fan_controller</span> <span class="o">=</span> <span class="n">FanController</span><span class="p">()</span>

      <span class="c1">#show the controller input and output in the ui.</span>
      <span class="n">fan_controller</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">()</span>
      <span class="n">fan_controller</span><span class="o">.</span><span class="n">fan_speed</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">()</span>

      <span class="c1">#link the fan controllers temp input to cpu temperature sensor</span>
      <span class="n">fan_controller</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">link_to</span><span class="p">(</span><span class="n">cpu_temp_sensor</span><span class="p">)</span>

      <span class="c1">#link to the motor controller device</span>
      <span class="kn">from</span> <span class="nn">kervi.devices.motors.adafruit_i2c_motor_hat</span> <span class="kn">import</span> <span class="n">AdafruitMotorHAT</span>
      <span class="n">motor_driver</span> <span class="o">=</span> <span class="n">AdafruitMotorHAT</span><span class="p">()</span>
      <span class="n">motor_driver</span><span class="o">.</span><span class="n">dc_motors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">link_to</span><span class="p">(</span><span class="n">fan_controller</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>

      <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Run the script and you should see something like this.</p>
<img alt="../_images/fan_controller.png" src="../_images/fan_controller.png" />
<p>Read more about all the possibilities with controllers <a class="reference internal" href="../controllers.html#controllers"><span class="std std-ref">here</span></a>.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dashboards.html" class="btn btn-neutral float-right" title="Dashboards" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="actions.html" class="btn btn-neutral" title="Actions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Tim Wentzlau.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.15.0 - beta',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>