

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Controllers &mdash; Kervi 0.11.1 - beta documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Kervi 0.11.1 - beta documentation" href="index.html"/>
        <link rel="next" title="Controllers api" href="controllers_api.html"/>
        <link rel="prev" title="Sensors API" href="sensors_api.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Kervi
          

          
          </a>

          
            
            
              <div class="version">
                0.11.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getstarted.html">Get started</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboards.html">Dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="sensors.html">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="sensors_api.html">Sensors API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Controllers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#input-and-output-interfaces">Input and output interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linking-controllers">Linking controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#controller-api">Controller api</a><ul>
<li class="toctree-l3"><a class="reference internal" href="controllers_api.html">Controllers api</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dynamic_values.html">Dynamic values</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera.html">Camera and video</a></li>
<li class="toctree-l1"><a class="reference internal" href="hal.html">Hardware and devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="ipc.html">Component communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Commandline tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Contribute</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Kervi</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Controllers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="controllers">
<h1>Controllers<a class="headerlink" href="#controllers" title="Permalink to this headline">¶</a></h1>
<p>Controllers is the fun part of your Kervi application this is where you code the application logic.
Your controller acts upon input from users, GPIO events or the underlaying os and initiates different actions based on the input.</p>
<p>Basic controllers manages motors, light, servos and so on but you can also build more advanced controllers
for <em>line following</em> and <em>self navigation</em>.
As your application grows your application will contain multiple controllers.</p>
<div class="section" id="input-and-output-interfaces">
<h2>Input and output interfaces<a class="headerlink" href="#input-and-output-interfaces" title="Permalink to this headline">¶</a></h2>
<p>Basically a controller reads a set of inputs and generates one or more outputs.
Below is an example of a steering controller, that takes speed, and left/right balance between motors as inputs
and calculates the speed of the left and right motors.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kn">from</span> <span class="nn">kervi.controller</span> <span class="kn">import</span> <span class="n">Controller</span>
 <span class="kn">from</span> <span class="nn">kervi.tasks</span> <span class="kn">import</span> <span class="n">TaskHandler</span>
 <span class="kn">from</span> <span class="nn">kervi.values</span> <span class="kn">import</span> <span class="o">*</span>

 <span class="k">class</span> <span class="nc">MotorSteering</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Control the speed and direction of two motors.</span>
<span class="sd">     &quot;&quot;&quot;</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller_id</span><span class="o">=</span><span class="s2">&quot;steering&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Steering&quot;</span><span class="p">):</span>
         <span class="n">Controller</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller_id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;steering&quot;</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">left_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;left_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Left speed&quot;</span><span class="p">,</span> <span class="n">DynamicNumber</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">right_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;right_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Right speed&quot;</span><span class="p">,</span> <span class="n">DynamicNumber</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">adjust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;adjust&quot;</span><span class="p">,</span> <span class="s2">&quot;Left right adjust&quot;</span><span class="p">,</span> <span class="n">DynamicNumber</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Speed&quot;</span><span class="p">,</span> <span class="n">DynamicNumber</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;Direction&quot;</span><span class="p">,</span> <span class="n">DynamicNumber</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">all_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;all_off&quot;</span><span class="p">,</span> <span class="s2">&quot;All off&quot;</span><span class="p">,</span> <span class="n">DynamicBoolean</span><span class="p">)</span>

     <span class="nd">@property</span>
     <span class="k">def</span> <span class="nf">adjust</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust</span>

     <span class="nd">@adjust.setter</span>
     <span class="k">def</span> <span class="nf">adjust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_adjust</span> <span class="o">=</span> <span class="n">value</span>

     <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">new_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust</span><span class="o">.</span><span class="n">value</span>

         <span class="k">if</span> <span class="n">left_right_balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">left_speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">new_direction</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
             <span class="n">right_speed</span> <span class="o">=</span> <span class="n">speed</span>
         <span class="k">elif</span> <span class="n">left_right_balance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">left_speed</span> <span class="o">=</span> <span class="n">speed</span>
             <span class="n">right_speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">new_direction</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
         <span class="k">elif</span> <span class="n">left_right_balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">left_speed</span> <span class="o">=</span> <span class="n">speed</span>
             <span class="n">right_speed</span> <span class="o">=</span> <span class="n">speed</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">left_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">left_speed</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">right_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">right_speed</span>

     <span class="k">def</span> <span class="nf">input_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changed_input</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">changed_input</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_off</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_off</span><span class="o">.</span><span class="n">value</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">left_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">right_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

         <span class="k">if</span> <span class="n">changed_input</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="ow">or</span> <span class="n">changed_input</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>In the example above the inputs and outputs are defined via:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Speed&quot;</span><span class="p">,</span> <span class="n">DynamicNumber</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">left_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;left_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Left speed&quot;</span><span class="p">,</span> <span class="n">DynamicNumber</span><span class="p">)</span>
</pre></div>
</div>
<p>self.inputs.add and self.outputs.add are factory functions that creates dynamic values that are special Kervi value classes that
may be linked to dashboards or to another dynamic value.</p>
<p>When an input value is changed by a user or other part of your application the input_changed event is fired and your controller may
calculate its outputs.</p>
</div>
<div class="section" id="linking-controllers">
<h2>Linking controllers<a class="headerlink" href="#linking-controllers" title="Permalink to this headline">¶</a></h2>
<p>A controller that works entirely on in- and outputs that are dynamic values
is agnostic to how it is linked to user interface and hardware.
In that way it is easy to change hardware and make changes to UI without re-coding the controller.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="n">steering</span> <span class="o">=</span> <span class="n">MotorSteering</span><span class="p">()</span>

 <span class="c1">#Link to ui</span>
 <span class="n">steering</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;steering&quot;</span><span class="p">)</span>
 <span class="n">steering</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;steering&quot;</span><span class="p">)</span>
 <span class="n">steering</span><span class="o">.</span><span class="n">all_off</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;steering&quot;</span><span class="p">)</span>

 <span class="c1">#link to hardware</span>
 <span class="n">motor_board</span> <span class="o">=</span> <span class="n">AdafruitMotorHAT</span><span class="p">()</span>
 <span class="n">motor_board</span><span class="o">.</span><span class="n">dc_motors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">link_to</span><span class="p">(</span><span class="n">steering</span><span class="o">.</span><span class="n">left_speed</span><span class="p">)</span>
 <span class="n">motor_board</span><span class="o">.</span><span class="n">dc_motors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">link_to</span><span class="p">(</span><span class="n">steering</span><span class="o">.</span><span class="n">right_speed</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="controller-api">
<h2>Controller api<a class="headerlink" href="#controller-api" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="controllers_api.html" class="btn btn-neutral float-right" title="Controllers api" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sensors_api.html" class="btn btn-neutral" title="Sensors API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Tim Wentzlau.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.11.1 - beta',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>