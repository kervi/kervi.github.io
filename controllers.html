

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Controllers</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="" href="index.html"/>
        <link rel="next" title="Signal handling" href="signals.html"/>
        <link rel="prev" title="Sensors" href="sensors.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Kervi
          

          
          </a>

          
            
            
              <div class="version">
                0.20.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getstarted/index.html">Get started</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboards.html">Dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="sensors.html">Sensors</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">Signal handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="actions.html">Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera.html">Camera and video</a></li>
<li class="toctree-l1"><a class="reference internal" href="motors.html">Motors</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpio.html">GPIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="display.html">Displays</a></li>
<li class="toctree-l1"><a class="reference internal" href="messaging.html">Messaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="hal.html">Hardware and devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="devices/index.html">Device library</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_process.html">Process distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed.html">Distributed applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="service.html">Run as service</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Commandline tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="ipc.html">Interprocess communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="kervi_api.html">Kervi API</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Contribute</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Kervi</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Controllers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>Controllers<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h1>
<p>A controller reacts to one or more inputs and computes one or more outputs.
The input could come from the user via the web based UI, gpio, sensors or other application logic.</p>
<p>Basic controllers manages motors, light, servos and so on but you can also build more advanced controllers
for <em>line following</em> and <em>self navigation</em>.</p>
<p>Below is an example of a steering controller, that takes speed, and left/right balance between motors as inputs
and calculates the speed of the left and right motors.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kn">from</span> <span class="nn">kervi.controllers</span> <span class="kn">import</span> <span class="n">Controller</span>
 <span class="kn">from</span> <span class="nn">kervi.values</span> <span class="kn">import</span> <span class="o">*</span>

 <span class="k">class</span> <span class="nc">MotorSteering</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Control the speed and direction of two motors.</span>
<span class="sd">     &quot;&quot;&quot;</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller_id</span><span class="o">=</span><span class="s2">&quot;steering&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Steering&quot;</span><span class="p">):</span>
         <span class="n">Controller</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller_id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;steering&quot;</span>

         <span class="c1">#create the inputs</span>
         <span class="c1"># speed value is from -100 to 100.</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Speed&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>

         <span class="c1">#direction - -100 is max left, 0 is strait ahead, 100 is max right</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;Direction&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>

         <span class="c1">#create outputs</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">left_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;left_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Left speed&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">right_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;right_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Right speed&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">new_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">value</span>

         <span class="k">if</span> <span class="n">left_right_balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">left_speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">new_direction</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
             <span class="n">right_speed</span> <span class="o">=</span> <span class="n">speed</span>
         <span class="k">elif</span> <span class="n">left_right_balance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">left_speed</span> <span class="o">=</span> <span class="n">speed</span>
             <span class="n">right_speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">new_direction</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
         <span class="k">elif</span> <span class="n">left_right_balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">left_speed</span> <span class="o">=</span> <span class="n">speed</span>
             <span class="n">right_speed</span> <span class="o">=</span> <span class="n">speed</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">left_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">left_speed</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">right_speed</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">right_speed</span>

     <span class="k">def</span> <span class="nf">input_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changed_input</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">changed_input</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="ow">or</span> <span class="n">changed_input</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

 <span class="c1">#instantiate controller</span>
 <span class="n">steering</span> <span class="o">=</span> <span class="n">MotorSteering</span><span class="p">()</span>

 <span class="c1">#Link to ui</span>
 <span class="n">steering</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;steering&quot;</span><span class="p">)</span>
 <span class="n">steering</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;steering&quot;</span><span class="p">)</span>
 <span class="n">steering</span><span class="o">.</span><span class="n">all_off</span><span class="o">.</span><span class="n">link_to_dashboard</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;steering&quot;</span><span class="p">)</span>

 <span class="c1">#link to hardware</span>
 <span class="n">motor_board</span> <span class="o">=</span> <span class="n">AdafruitMotorHAT</span><span class="p">()</span>
 <span class="n">motor_board</span><span class="o">.</span><span class="n">dc_motors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">link_to</span><span class="p">(</span><span class="n">steering</span><span class="o">.</span><span class="n">left_speed</span><span class="p">)</span>
 <span class="n">motor_board</span><span class="o">.</span><span class="n">dc_motors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">link_to</span><span class="p">(</span><span class="n">steering</span><span class="o">.</span><span class="n">right_speed</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>In the example above the inputs and outputs are defined via:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Speed&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">left_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;left_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;Left speed&quot;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">)</span>
</pre></div>
</div>
<p>self.inputs.add and self.outputs.add are factory functions that creates kervi values that are special value classes that
may be linked to dashboards or to another dynamic values.</p>
<p>When an input value is changed by a user or other part of your application the input_changed event is fired and your controller may
calculate its outputs.</p>
<p>A controller that works entirely on in- and outputs is agnostic to how it is linked to user interface and hardware.
In that way it is easy to change hardware and make changes to UI without re-coding the controller.</p>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="signals.html" class="btn btn-neutral float-right" title="Signal handling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sensors.html" class="btn btn-neutral" title="Sensors" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Tim Wentzlau.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>